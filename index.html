<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>GPS Logger</title>

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#1976D2" />

    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.prod.css" rel="stylesheet" />

    <style>
      body {
        overscroll-behavior: contain;
        user-select: none;
      }
      .debug-console {
        font-family: monospace;
        font-size: 11px;
        height: 150px;
        overflow-y: auto;
        background: #111;
        color: #0f0;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #333;
      }
      .flash {
        animation: flash 0.2s ease-out;
      }
      @keyframes flash {
        0% {
          background: rgba(0, 255, 0, 0.3);
        }
        100% {
          background: transparent;
        }
      }
    </style>
  </head>

  <body>
    <div id="q-app" :class="{ flash: isFlashing }">
      <q-layout view="lHh Lpr lFf">
        <q-header elevated class="bg-primary text-white">
          <q-toolbar>
            <q-icon name="my_location" class="q-mr-sm" />
            <q-toolbar-title>GPS Logger</q-toolbar-title>
            <q-btn flat dense round icon="delete" @click="clearHistory" />
          </q-toolbar>
        </q-header>

        <q-page-container>
          <q-page class="q-pa-md">
            <!-- BLE Connection Card -->
            <q-card class="q-mb-md">
              <q-card-section>
                <div class="text-h6 q-mb-sm">
                  <q-icon name="bluetooth" />
                  ESP32 Connection
                </div>
                
                <q-btn 
                  v-if="!bleConnected"
                  color="primary" 
                  icon="bluetooth_searching"
                  label="Connect to ESP32"
                  @click="connectBLE"
                  :loading="bleConnecting"
                  :disable="!bluetoothAvailable"
                />
                
                <div v-else class="text-positive">
                  <q-icon name="check_circle" />
                  Connected to {{ bleDeviceName }}
                  <q-btn 
                    flat 
                    dense 
                    size="sm" 
                    color="negative" 
                    label="Disconnect"
                    @click="disconnectBLE"
                    class="q-ml-sm"
                  />
                </div>

                <div v-if="!bluetoothAvailable" class="text-warning q-mt-sm text-caption">
                  ‚ö†Ô∏è Web Bluetooth not available. Open in Chrome/Edge on your phone.
                </div>
              </q-card-section>
            </q-card>

            <div class="debug-console q-mb-md">
              <div v-for="(l,i) in logs" :key="i">> {{ l }}</div>
            </div>

            <div class="text-center q-mb-md">
              <q-btn round size="xl" color="secondary" icon="add_location" @click="captureLocation('Manual Tap')" />
              <div class="text-caption q-mt-sm">Tap to capture location</div>
            </div>

            <q-list bordered separator v-if="locations.length > 0">
              <q-item v-for="loc in locations" :key="loc.id">
                <q-item-section>
                  <q-item-label>{{ loc.lat.toFixed(5) }}, {{ loc.lng.toFixed(5) }}</q-item-label>
                  <q-item-label caption> {{ loc.trigger }} ‚Ä¢ {{ new Date(loc.time).toLocaleTimeString() }} </q-item-label>
                </q-item-section>
              </q-item>
            </q-list>
          </q-page>
        </q-page-container>
      </q-layout>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.umd.prod.js"></script>

    <script>
      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          const locations = ref([]);
          const logs = ref([]);
          const isFlashing = ref(false);
          const bleConnected = ref(false);
          const bleConnecting = ref(false);
          const bleDeviceName = ref('');
          const bluetoothAvailable = ref(false);
          
          let bleDevice = null;
          let bleCharacteristic = null;

          const log = (m) => {
            const time = new Date().toLocaleTimeString();
            logs.value.unshift(`${time} ${m}`);
            if (logs.value.length > 50) logs.value.pop();
            console.log(m);
          };

          const flash = () => {
            isFlashing.value = true;
            setTimeout(() => (isFlashing.value = false), 200);
          };

          const captureLocation = (trigger) => {
            log("TRIGGER: " + trigger);
            flash();

            if (!navigator.geolocation) {
              log("‚ùå Geolocation not available");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const d = {
                  id: Date.now(),
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                  time: Date.now(),
                  trigger,
                };
                locations.value.unshift(d);
                try {
                  localStorage.setItem("gps_logs", JSON.stringify(locations.value));
                  log("‚úì Location saved");
                } catch (e) {
                  log("‚ö†Ô∏è Storage error: " + e.message);
                }
              },
              (e) => log("‚ùå GPS error: " + e.message),
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          };

          const connectBLE = async () => {
            if (!bluetoothAvailable.value) {
              log("‚ùå Web Bluetooth not supported");
              return;
            }

            bleConnecting.value = true;
            log("Scanning for BLE devices...");

            try {
              bleDevice = await navigator.bluetooth.requestDevice({
                filters: [
                  { name: 'GPS Shutterer' }
                ],
                optionalServices: [
                  '00001812-0000-1000-8000-00805f9b34fb', // HID Service
                  '0000180f-0000-1000-8000-00805f9b34fb', // Battery Service
                  '0000180a-0000-1000-8000-00805f9b34fb'  // Device Info
                ]
              });

              bleDeviceName.value = bleDevice.name || 'ESP32';
              log(`‚úì Found: ${bleDeviceName.value}`);

              bleDevice.addEventListener('gattserverdisconnected', () => {
                log("‚ùå BLE disconnected");
                bleConnected.value = false;
                bleCharacteristic = null;
              });

              log("Connecting to GATT server...");
              const server = await bleDevice.gatt.connect();
              log("‚úì GATT connected");
              
              log("Getting HID service...");
              const hidService = await server.getPrimaryService('00001812-0000-1000-8000-00805f9b34fb');
              log("‚úì HID service found");
              
              log("Getting Report characteristic...");
              bleCharacteristic = await hidService.getCharacteristic('00002a4d-0000-1000-8000-00805f9b34fb');
              log("‚úì Report characteristic found");
              
              log("Starting notifications...");
              await bleCharacteristic.startNotifications();
              log("‚úì Notifications started");
              
              bleCharacteristic.addEventListener('characteristicvaluechanged', handleBLEData);

              bleConnected.value = true;
              log("‚úÖ Connected! Press ESP32 button");

            } catch (error) {
              log(`‚ùå Error: ${error.message || error}`);
              console.error('BLE Error:', error);
              
              if (error.message && error.message.includes('User cancelled')) {
                log("Connection cancelled by user");
              }
            } finally {
              bleConnecting.value = false;
            }
          };

          const handleBLEData = (event) => {
            try {
              const value = event.target.value;
              const data = new Uint8Array(value.buffer);
              
              log(`Data: [${Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ')}]`);
              
              // Check for Enter key (0x28 in keyboard reports)
              if (data.length >= 3 && data[2] === 0x28) {
                log("üîò ESP32 BUTTON PRESSED!");
                captureLocation("ESP32 Button");
              } else if (data.length >= 3 && data[2] !== 0) {
                log(`Key code: 0x${data[2].toString(16)}`);
              }
            } catch (error) {
              log(`‚ùå Data error: ${error.message}`);
            }
          };

          const disconnectBLE = () => {
            try {
              if (bleCharacteristic) {
                bleCharacteristic.removeEventListener('characteristicvaluechanged', handleBLEData);
              }
              if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                log("Disconnected from ESP32");
              }
            } catch (error) {
              log(`Disconnect error: ${error.message}`);
            }
            bleConnected.value = false;
            bleCharacteristic = null;
            bleDevice = null;
          };

          onMounted(() => {
            bluetoothAvailable.value = !!navigator.bluetooth;

            try {
              const saved = localStorage.getItem("gps_logs");
              if (saved) {
                locations.value = JSON.parse(saved);
              }
            } catch (e) {
              log("‚ö†Ô∏è Could not load saved locations");
            }

            if (bluetoothAvailable.value) {
              log("‚úì Web Bluetooth available");
              log("Click 'Connect to ESP32' button");
            } else {
              log("‚ùå Web Bluetooth not available");
              log("Please use Chrome or Edge browser");
            }
          });

          return {
            locations,
            logs,
            isFlashing,
            bleConnected,
            bleConnecting,
            bleDeviceName,
            bluetoothAvailable,
            captureLocation,
            connectBLE,
            disconnectBLE,
            clearHistory() {
              locations.value = [];
              try {
                localStorage.removeItem("gps_logs");
                log("History cleared");
              } catch (e) {
                log("Clear error: " + e.message);
              }
            },
          };
        },
      })
        .use(Quasar)
        .mount("#q-app");
    </script>
  </body>
</html>
