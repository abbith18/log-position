<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>GPS Logger</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.prod.css" rel="stylesheet" />

    <style>
      body {
        overscroll-behavior: contain;
        user-select: none;
      }
      .debug-console {
        font-family: monospace;
        font-size: 11px;
        height: 180px;
        overflow-y: auto;
        background: #111;
        color: #0f0;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #333;
      }
      .flash {
        animation: flash 0.2s ease-out;
      }
      @keyframes flash {
        0% { background: rgba(0, 255, 0, 0.3); }
        100% { background: transparent; }
      }
    </style>
  </head>

  <body>
    <div id="q-app"></div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.umd.prod.js"></script>

    <script>
      const { createApp, ref, onMounted, h } = Vue;

      const App = {
        setup() {
          const locations = ref([]);
          const logs = ref([]);
          const isFlashing = ref(false);
          const bleConnected = ref(false);
          const bleConnecting = ref(false);
          const bleDeviceName = ref('');
          const bluetoothAvailable = ref(false);
          
          let bleDevice = null;
          let bleCharacteristics = [];

          const log = (m) => {
            const time = new Date().toLocaleTimeString();
            logs.value.unshift(`${time} ${m}`);
            if (logs.value.length > 80) logs.value.pop();
            console.log(m);
          };

          const flash = () => {
            isFlashing.value = true;
            setTimeout(() => (isFlashing.value = false), 200);
          };

          const captureLocation = (trigger) => {
            log("TRIGGER: " + trigger);
            flash();

            if (!navigator.geolocation) {
              log("âŒ Geolocation not available");
              return;
            }

            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const d = {
                  id: Date.now(),
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                  time: Date.now(),
                  trigger,
                };
                locations.value.unshift(d);
                try {
                  localStorage.setItem("gps_logs", JSON.stringify(locations.value));
                  log("âœ“ Location saved");
                } catch (e) {
                  log("âš ï¸ Storage error");
                }
              },
              (e) => log("âŒ GPS error: " + e.message),
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
          };

          const connectBLE = async () => {
            if (!bluetoothAvailable.value) {
              log("âŒ Web Bluetooth not supported");
              return;
            }

            bleConnecting.value = true;
            log("Scanning for BLE devices...");

            try {
              bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'GPS Shutterer' }],
                optionalServices: ['00001812-0000-1000-8000-00805f9b34fb']
              });

              bleDeviceName.value = bleDevice.name || 'ESP32';
              log(`âœ“ Found: ${bleDeviceName.value}`);

              bleDevice.addEventListener('gattserverdisconnected', () => {
                log("âŒ Disconnected");
                bleConnected.value = false;
                bleCharacteristics = [];
              });

              log("Connecting...");
              const server = await bleDevice.gatt.connect();
              log("âœ“ GATT connected");
              
              log("Getting HID service...");
              const hidService = await server.getPrimaryService('00001812-0000-1000-8000-00805f9b34fb');
              log("âœ“ HID service found");
              
              log("Getting characteristics...");
              const characteristics = await hidService.getCharacteristics();
              log(`âœ“ Found ${characteristics.length} characteristics`);
              
              for (const char of characteristics) {
                log(`  UUID: ${char.uuid}`);
                
                if (char.properties.notify) {
                  try {
                    await char.startNotifications();
                    char.addEventListener('characteristicvaluechanged', (event) => {
                      handleBLEData(event, char.uuid);
                    });
                    bleCharacteristics.push(char);
                    log(`  âœ“ Subscribed`);
                  } catch (e) {
                    log(`  âš ï¸ Subscribe failed`);
                  }
                }
              }

              bleConnected.value = true;
              log("âœ… Ready! Press ESP32 button");

            } catch (error) {
              log(`âŒ Error: ${error.message || error}`);
              console.error('BLE Error:', error);
            } finally {
              bleConnecting.value = false;
            }
          };

          const handleBLEData = (event, uuid) => {
            try {
              const value = event.target.value;
              const data = new Uint8Array(value.buffer);
              
              const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' ');
              log(`[${uuid.substring(4, 8)}]: ${hex}`);
              
              // Volume Up (Report ID 2, bit 0)
              if (data.length >= 2 && data[0] === 0x02 && data[1] === 0x01) {
                log("ðŸ”Š VOLUME UP!");
                captureLocation("ESP32 Button");
              }
              // Enter key (Report ID 1, 0x28)
              else if (data.length >= 3 && data[0] === 0x01 && data[2] === 0x28) {
                log("âŒ¨ï¸ ENTER KEY!");
                captureLocation("ESP32 Button");
              }
            } catch (error) {
              log(`âŒ Parse error`);
            }
          };

          const disconnectBLE = () => {
            try {
              if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                log("Disconnected");
              }
            } catch (error) {
              log(`Disconnect error`);
            }
            bleConnected.value = false;
            bleCharacteristics = [];
            bleDevice = null;
          };

          const clearHistory = () => {
            locations.value = [];
            localStorage.removeItem("gps_logs");
            log("History cleared");
          };

          onMounted(() => {
            bluetoothAvailable.value = !!navigator.bluetooth;

            try {
              const saved = localStorage.getItem("gps_logs");
              if (saved) locations.value = JSON.parse(saved);
            } catch (e) {
              log("âš ï¸ Load error");
            }

            if (bluetoothAvailable.value) {
              log("âœ“ Web Bluetooth available");
              log("Click 'Connect to ESP32'");
            } else {
              log("âŒ Web Bluetooth unavailable");
              log("Use Chrome or Edge");
            }
          });

          return {
            locations,
            logs,
            isFlashing,
            bleConnected,
            bleConnecting,
            bleDeviceName,
            bluetoothAvailable,
            captureLocation,
            connectBLE,
            disconnectBLE,
            clearHistory
          };
        },

        render() {
          return h(Quasar.QLayout, { view: 'lHh Lpr lFf', class: this.isFlashing ? 'flash' : '' }, {
            default: () => [
              h(Quasar.QHeader, { elevated: true, class: 'bg-primary text-white' }, {
                default: () => h(Quasar.QToolbar, {}, {
                  default: () => [
                    h(Quasar.QIcon, { name: 'my_location', class: 'q-mr-sm' }),
                    h(Quasar.QToolbarTitle, {}, { default: () => 'GPS Logger' }),
                    h(Quasar.QBtn, { flat: true, dense: true, round: true, icon: 'delete', onClick: this.clearHistory })
                  ]
                })
              }),
              h(Quasar.QPageContainer, {}, {
                default: () => h(Quasar.QPage, { class: 'q-pa-md' }, {
                  default: () => [
                    h(Quasar.QCard, { class: 'q-mb-md' }, {
                      default: () => h(Quasar.QCardSection, {}, {
                        default: () => [
                          h('div', { class: 'text-h6 q-mb-sm' }, [
                            h(Quasar.QIcon, { name: 'bluetooth' }),
                            ' ESP32 Connection'
                          ]),
                          !this.bleConnected ? 
                            h(Quasar.QBtn, {
                              color: 'primary',
                              icon: 'bluetooth_searching',
                              label: 'Connect to ESP32',
                              onClick: this.connectBLE,
                              loading: this.bleConnecting,
                              disable: !this.bluetoothAvailable
                            }) :
                            h('div', { class: 'text-positive' }, [
                              h(Quasar.QIcon, { name: 'check_circle' }),
                              ` Connected to ${this.bleDeviceName}`,
                              h(Quasar.QBtn, {
                                flat: true,
                                dense: true,
                                size: 'sm',
                                color: 'negative',
                                label: 'Disconnect',
                                onClick: this.disconnectBLE,
                                class: 'q-ml-sm'
                              })
                            ]),
                          !this.bluetoothAvailable ? 
                            h('div', { class: 'text-warning q-mt-sm text-caption' }, 
                              'âš ï¸ Web Bluetooth not available. Use Chrome or Edge.'
                            ) : null
                        ]
                      })
                    }),
                    h('div', { class: 'debug-console q-mb-md' },
                      this.logs.map((l, i) => h('div', { key: i }, `> ${l}`))
                    ),
                    h('div', { class: 'text-center q-mb-md' }, [
                      h(Quasar.QBtn, {
                        round: true,
                        size: 'xl',
                        color: 'secondary',
                        icon: 'add_location',
                        onClick: () => this.captureLocation('Manual Tap')
                      }),
                      h('div', { class: 'text-caption q-mt-sm' }, 'Tap to capture location')
                    ]),
                    this.locations.length > 0 ? 
                      h(Quasar.QList, { bordered: true, separator: true },
                        this.locations.map(loc => 
                          h(Quasar.QItem, { key: loc.id }, {
                            default: () => h(Quasar.QItemSection, {}, {
                              default: () => [
                                h(Quasar.QItemLabel, {}, 
                                  `${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`
                                ),
                                h(Quasar.QItemLabel, { caption: true }, 
                                  `${loc.trigger} â€¢ ${new Date(loc.time).toLocaleTimeString()}`
                                )
                              ]
                            })
                          })
                        )
                      ) : null
                  ]
                })
              })
            ]
          });
        }
      };

      createApp(App).use(Quasar).mount('#q-app');
    </script>
  </body>
</html>
