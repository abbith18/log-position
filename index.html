<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quasar GPS Logger</title>
    
    <!-- PWA / Mobile App Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1976D2">
    
    <!-- Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "GPS Logger",
        "short_name": "GPS Log",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#1976D2",
        "icons": [{
            "src": "https://cdn.quasar.dev/logo-v2/svg/logo.svg",
            "sizes": "any",
            "type": "image/svg+xml"
        }]
    }'>

    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
    
    <!-- Quasar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/quasar@2.14.2/dist/quasar.prod.css" rel="stylesheet" type="text/css">
    
    <style>
        body { overscroll-behavior-y: contain; }
        .location-card { transition: all 0.3s ease; }
        .location-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .debug-console { font-family: monospace; font-size: 10px; max-height: 100px; overflow-y: auto; background: #000; color: #0f0; padding: 5px; }
    </style>
</head>
<body>
    <div id="q-app">
        <q-layout view="lHh Lpr lFf" class="bg-grey-2">
            <q-header elevated class="bg-primary text-white">
                <q-toolbar>
                    <q-icon name="my_location" size="md" class="q-mr-sm"></q-icon>
                    <q-toolbar-title>GPS Logger</q-toolbar-title>
                    <q-btn flat round dense icon="delete_sweep" @click="clearHistory" v-if="locations.length > 0">
                        <q-tooltip>Clear History</q-tooltip>
                    </q-btn>
                </q-toolbar>
            </q-header>

            <q-page-container>
                <q-page class="q-pa-md">
                    
                    <div class="row q-col-gutter-md justify-center">
                        
                        <!-- Activation Card (Essential for Android) -->
                        <div class="col-12 col-md-8">
                            <q-card class="bg-blue-1 text-center q-pa-sm">
                                <div class="text-subtitle2 q-mb-sm text-primary">Step 1: Activate Sensor</div>
                                <div class="text-caption text-grey-8 q-mb-md">
                                    Click below to start listening. This plays silent audio to keep the app awake and capture media buttons.
                                </div>
                                <q-btn 
                                    :color="isListening ? 'positive' : 'negative'" 
                                    :icon="isListening ? 'hearing' : 'mic_off'"
                                    :label="isListening ? 'Sensor Active' : 'Start Sensor / Keep Awake'"
                                    class="full-width q-mb-sm"
                                    size="lg"
                                    @click="toggleListener"
                                ></q-btn>
                                <div v-if="isListening" class="text-xs text-green-8 text-weight-bold animated fadeIn">
                                    • Listening for Keys & Media Commands •
                                </div>
                            </q-card>
                        </div>

                        <!-- Manual Trigger -->
                        <div class="col-12 col-md-8 text-center">
                            <q-btn 
                                push 
                                color="secondary" 
                                size="xl" 
                                round 
                                icon="add_location" 
                                class="q-mb-md shadow-10"
                                @click="captureLocation('Manual')"
                            >
                            </q-btn>
                            <div class="text-caption text-grey-8">Manual Trigger</div>
                        </div>

                        <!-- Debug Log (To see if keys work) -->
                        <div class="col-12 col-md-8">
                            <div class="text-caption">Debug Log:</div>
                            <div class="debug-console rounded-borders" ref="logContainer">
                                <div v-for="(log, i) in debugLogs" :key="i">> {{ log }}</div>
                            </div>
                        </div>

                        <!-- Location List -->
                        <div class="col-12 col-md-8">
                            <div class="text-h6 q-mb-sm">Saved Locations ({{ locations.length }})</div>
                            
                            <div v-if="locations.length === 0" class="text-center q-pa-lg text-grey">
                                <q-icon name="explore_off" size="xl" class="q-mb-sm"></q-icon>
                                <div>No locations saved yet.</div>
                            </div>

                            <q-list separator bordered class="bg-white rounded-borders shadow-1">
                                <q-item v-for="loc in locations" :key="loc.id" class="location-card">
                                    <q-item-section avatar>
                                        <q-avatar color="primary" text-color="white" icon="place"></q-avatar>
                                    </q-item-section>
                                    
                                    <q-item-section>
                                        <q-item-label class="text-weight-bold">
                                            {{ loc.lat.toFixed(6) }}, {{ loc.lng.toFixed(6) }}
                                        </q-item-label>
                                        <q-item-label caption lines="1">
                                            Accuracy: +/- {{ Math.round(loc.accuracy) }}m • {{ loc.triggerType }}
                                        </q-item-label>
                                    </q-item-section>

                                    <q-item-section side>
                                        <div class="text-caption">{{ formatTime(loc.timestamp) }}</div>
                                        <q-btn flat round color="primary" icon="map" :href="getMapLink(loc)" target="_blank" dense></q-btn>
                                    </q-item-section>
                                </q-item>
                            </q-list>
                        </div>
                    </div>
                </q-page>
            </q-page-container>
            
            <!-- Hidden Audio Element for "Keep Awake" trick -->
            <audio id="silentAudio" loop>
                <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAAAAMA==" type="audio/mpeg">
            </audio>

        </q-layout>
    </div>

    <!-- Vue and Quasar JS -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.2/dist/quasar.umd.prod.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { createApp, ref, onMounted, onUnmounted } = Vue;
            const { useQuasar } = Quasar;

            const app = createApp({
                setup() {
                    const $q = useQuasar();
                    
                    // State
                    const locations = ref([]);
                    const debugLogs = ref(['Ready. Click "Start Sensor" to begin.']);
                    const isListening = ref(false);
                    const logContainer = ref(null);

                    // --- Logging Helper ---
                    const log = (msg) => {
                        debugLogs.value.unshift(`${new Date().toLocaleTimeString().split(' ')[0]} ${msg}`);
                        if (debugLogs.value.length > 20) debugLogs.value.pop();
                    };

                    // --- Data Logic (LocalStorage) ---
                    const loadLocations = () => {
                        try {
                            const stored = localStorage.getItem('gps_logs');
                            if (stored) {
                                locations.value = JSON.parse(stored);
                                locations.value.sort((a, b) => b.timestamp - a.timestamp);
                            }
                        } catch (e) {
                            log("Error loading data");
                        }
                    };

                    const saveLocationLocal = (position, type) => {
                        const data = {
                            id: Date.now().toString() + Math.random().toString().slice(2, 6),
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: Date.now(),
                            triggerType: type
                        };
                        locations.value.unshift(data);
                        try {
                            localStorage.setItem('gps_logs', JSON.stringify(locations.value));
                            $q.notify({ type: 'positive', message: 'Saved!', position: 'top', timeout: 1000 });
                            log(`Saved: ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)}`);
                        } catch (e) {
                            log("Storage Error");
                        }
                    };

                    const clearHistory = () => {
                        if(!confirm("Delete all history?")) return;
                        localStorage.removeItem('gps_logs');
                        locations.value = [];
                        log("History cleared");
                    };

                    // --- Audio / Keep Awake Logic ---
                    const toggleListener = async () => {
                        const audio = document.getElementById('silentAudio');
                        if (!isListening.value) {
                            try {
                                await audio.play();
                                isListening.value = true;
                                log("Sensor Active (Audio Playing)");
                                setupMediaSession();
                            } catch (e) {
                                log("Error starting audio: " + e.message);
                                $q.notify({ message: "Tap screen first!", color: "orange" });
                            }
                        } else {
                            audio.pause();
                            isListening.value = false;
                            log("Sensor Stopped");
                        }
                    };

                    // --- Media Session API (The Secret Sauce) ---
                    // This allows us to catch "Play/Pause" buttons from headsets/remotes
                    const setupMediaSession = () => {
                        if ('mediaSession' in navigator) {
                            const actionHandler = (details) => {
                                log(`Media Cmd: ${details.action}`);
                                captureLocation(`Media: ${details.action}`);
                            };
                            
                            const actions = ['play', 'pause', 'previoustrack', 'nexttrack', 'stop', 'seekbackward', 'seekforward'];
                            
                            actions.forEach(action => {
                                try {
                                    navigator.mediaSession.setActionHandler(action, () => actionHandler({ action }));
                                } catch (error) {
                                    // Ignore unsupported actions
                                }
                            });
                        }
                    };

                    // --- GPS Logic ---
                    const captureLocation = (triggerType) => {
                        log(`Triggering: ${triggerType}`);
                        if (!navigator.geolocation) {
                            log("No GPS support");
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => saveLocationLocal(position, triggerType),
                            (error) => {
                                let msg = 'GPS Error';
                                if (error.code === 1) msg = 'GPS Denied';
                                if (error.code === 2) msg = 'GPS Unavailable';
                                if (error.code === 3) msg = 'GPS Timeout';
                                log(msg);
                                $q.notify({ type: 'negative', message: msg });
                            },
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                        );
                    };

                    // --- Standard Keyboard Logic ---
                    const handleKeydown = (e) => {
                        if (!isListening.value) return; // Only log if active
                        
                        log(`Key: ${e.key} (${e.code})`);
                        
                        // Treat ANY key as a trigger if listener is active
                        // This fixes the "Unknown key" issue.
                        const ignoredKeys = ['Control', 'Shift', 'Alt', 'Meta'];
                        if (!ignoredKeys.includes(e.key)) {
                            // Prevent default volume/scroll behavior
                            if (e.cancelable) e.preventDefault();
                            captureLocation(`Key: ${e.key}`);
                        }
                    };

                    // --- Lifecycle ---
                    onMounted(() => {
                        loadLocations();
                        window.addEventListener('keydown', handleKeydown);
                    });

                    onUnmounted(() => {
                        window.removeEventListener('keydown', handleKeydown);
                    });

                    // --- Helpers ---
                    const formatTime = (ts) => new Date(ts).toLocaleString();
                    const getMapLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;

                    return {
                        locations, debugLogs, isListening,
                        toggleListener, captureLocation, clearHistory,
                        formatTime, getMapLink
                    };
                }
            });

            app.use(Quasar);
            app.mount('#q-app');
        });
    </script>
</body>
</html>
